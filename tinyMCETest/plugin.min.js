!function(){"use strict";tinymce.PluginManager.add("test-plugin",function(e,t){var i,o=e.getParam("mentions");console.log(o),(o=o||{delimiter:"@"}).delimiter=o.delimiter||"@",e.on("keypress",function(t){String.fromCharCode(t.which||t.keyCode).includes(o.delimiter)&&(console.log(e.getContent()),console.log(e.selection.getRng()),void 0!==i&&(void 0===i.hasFocus||i.hasFocus)||(t.preventDefault(),i=new s(e,o)))});var s=function(t,e){this.editor=t,this.options=e||{source:[],delay:500,queryBy:"name",items:10},this.options.insertFrom=this.options.insertFrom||this.options.queryBy,this.matcher=this.options.matcher||this.matcher,this.sorter=this.options.sorter||this.sorter,this.renderDropdown=this.options.renderDropdown||this.renderDropdown,this.render=this.options.render||this.render,this.insert=this.options.insert||this.insert,this.highlighter=this.options.highlighter||this.highlighter,this.query="",this.hasFocus=!0,this.renderInput(),this.bindEvents()};s.prototype={constructor:s,renderInput:function(){var t='<span id="autocomplete"><span id="autocomplete-delimiter">'+this.options.delimiter+'</span><span id="autocomplete-searchtext"><span class="dummy">\ufeff</span></span></span>';this.editor.execCommand("mceInsertContent",!1,t),this.editor.focus(),this.editor.selection.select(this.editor.selection.dom.select("span#autocomplete-searchtext span")[0]),this.editor.selection.collapse(0)},bindEvents:function(){this.editor.on("keyup",this.editorKeyUpProxy=$.proxy(this.rteKeyUp,this)),this.editor.on("keydown",this.editorKeyDownProxy=$.proxy(this.rteKeyDown,this),!0),this.editor.on("click",this.editorClickProxy=$.proxy(this.rteClicked,this)),$("body").on("click",this.bodyClickProxy=$.proxy(this.rteLostFocus,this)),$(this.editor.getWin()).on("scroll",this.rteScroll=$.proxy(function(){this.cleanUp(!0)},this))},unbindEvents:function(){this.editor.off("keyup",this.editorKeyUpProxy),this.editor.off("keydown",this.editorKeyDownProxy),this.editor.off("click",this.editorClickProxy),$("body").off("click",this.bodyClickProxy),$(this.editor.getWin()).off("scroll",this.rteScroll)},rteKeyUp:function(t){switch(t.which||t.keyCode){case 40:case 38:case 16:case 17:case 18:break;case 8:""===this.query?this.cleanUp(!0):this.lookup();break;case 9:case 13:var e=void 0!==this.$dropdown?this.$dropdown.find("li.active"):[];e.length?(this.select(e.data()),this.cleanUp(!1)):this.cleanUp(!0);break;case 27:this.cleanUp(!0);break;default:this.lookup()}},rteKeyDown:function(t){switch(t.which||t.keyCode){case 9:case 13:case 27:t.preventDefault();break;case 38:t.preventDefault(),void 0!==this.$dropdown&&this.highlightPreviousResult();break;case 40:t.preventDefault(),void 0!==this.$dropdown&&this.highlightNextResult()}t.stopPropagation()},rteClicked:function(t){t=$(t.target);this.hasFocus&&"autocomplete-searchtext"!==t.parent().attr("id")&&this.cleanUp(!0)},rteLostFocus:function(){this.hasFocus&&this.cleanUp(!0)},lookup:function(){this.query=$.trim($(this.editor.getBody()).find("#autocomplete-searchtext").text()).replace("\ufeff",""),void 0===this.$dropdown&&this.show(),clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout($.proxy(function(){var t=$.isFunction(this.options.source)?this.options.source(this.query,$.proxy(this.process,this),this.options.delimiter):this.options.source;t&&this.process(t)},this),this.options.delay)},matcher:function(t){return~(null===(t=t[this.options.queryBy])||void 0===t?void 0:t.toLowerCase().indexOf(null===(t=this.query)||void 0===t?void 0:t.toLowerCase()))},sorter:function(t){for(var e,i,o=[],s=[],n=[];void 0!==(i=t.shift());)(null!==(e=i[this.options.queryBy])&&void 0!==e&&e.toLowerCase().indexOf(null===(e=this.query)||void 0===e?void 0:e.toLowerCase())?~i[this.options.queryBy].indexOf(this.query)?s:n:o).push(i);return o.concat(s,n)},highlighter:function(t){return t.replace(new RegExp("("+this.query.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")+")","ig"),function(t,e){return"<strong>"+e+"</strong>"})},show:function(){var t=this.editor.inline?this.offsetInline():this.offset();this.$dropdown=$(this.renderDropdown()).css({top:t.top,left:t.left}),$("body").append(this.$dropdown),this.$dropdown.on("click",$.proxy(this.autoCompleteClick,this))},process:function(t){var o,s,n=this;this.hasFocus&&(o=[],s=$.grep(t,function(t){return n.matcher(t)}),s=(s=this.sorter(s)).slice(0,this.options.items),$.each(s,function(t,e){var i=$(n.render(e,t));i.html(i.html().replace(i.text(),n.highlighter(i.text()))),$.each(s[t],function(t,e){i.attr("data-"+t,e)}),o.push(i[0].outerHTML)}),o.length?this.$dropdown.html(o.join("")).show():(this.$dropdown.hide(),this.$dropdown.find("li").removeClass("active")))},renderDropdown:function(){return'<ul class="rte-autocomplete dropdown-menu"><li class="loading"></li></ul>'},render:function(t,e){return'<li><a href="javascript:;"><span>'+t[this.options.queryBy]+"</span></a></li>"},autoCompleteClick:function(t){var e=$(t.target).closest("li").data();$.isEmptyObject(e)||(this.select(e),this.cleanUp(!1)),t.stopPropagation(),t.preventDefault()},highlightPreviousResult:function(){var t=this.$dropdown.find("li.active").index(),t=0===t?this.$dropdown.find("li").length-1:--t;this.$dropdown.find("li").removeClass("active").eq(t).addClass("active")},highlightNextResult:function(){var t=this.$dropdown.find("li.active").index(),t=t===this.$dropdown.find("li").length-1?0:++t;this.$dropdown.find("li").removeClass("active").eq(t).addClass("active")},select:function(t){this.editor.focus();var e=this.editor.dom.select("span#autocomplete")[0];this.editor.dom.remove(e),this.editor.execCommand("mceInsertContent",!1,this.insert(t))},insert:function(t){return'<span style="color: orange; background-color: #eee4d1; padding: 0px 4px; border-radius: 8px;"  data-uuid="'.concat(t.uuid,'" data-type="User" >').concat(this.options.delimiter+t[this.options.insertFrom],"</span>&nbsp;")},cleanUp:function(t){var e,i;this.unbindEvents(),this.hasFocus=!1,void 0!==this.$dropdown&&(this.$dropdown.remove(),delete this.$dropdown),t&&(i=this.query,(e=$(this.editor.dom.select("span#autocomplete"))).length&&(t=$("<p>"+this.options.delimiter+i+"</p>")[0].firstChild,i=$(this.editor.selection.getNode()).offset().top===e.offset().top+(e.outerHeight()-e.height())/2,this.editor.dom.replace(t,e[0]),i&&(this.editor.selection.select(t),this.editor.selection.collapse())))},offset:function(){var t=$(this.editor.getContainer()).offset(),e=$(this.editor.getContentAreaContainer()).position(),i=$(this.editor.dom.select("span#autocomplete")).position();return{top:t.top+e.top+i.top+$(this.editor.selection.getNode()).innerHeight()-$(this.editor.getDoc()).scrollTop()+5,left:t.left+e.left+i.left}},offsetInline:function(){var t=$(this.editor.dom.select("span#autocomplete")).offset();return{top:t.top+$(this.editor.selection.getNode()).innerHeight()+5,left:t.left}}}})}();
